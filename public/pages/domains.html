<div class="hero">
  <h1>My Domains</h1>
  <p>Manage your claimed subdomains</p>
</div>

<div id="domains-list">
  <p class="loading">Loading your domains...</p>
</div>

<hr style="margin: 2rem 0; border-color: var(--border);">

<h2>Claim New Subdomain</h2>
<form id="claim-form" onsubmit="claimSubdomain(event)" style="max-width: 100%;">
  <div class="claim-form-row">
    <div class="form-group" style="flex: 1; margin-bottom: 0;">
      <label for="subdomain-input">Subdomain Name</label>
      <div class="input-with-suffix">
        <input type="text" id="subdomain-input" name="subdomain" required 
               pattern="[a-z0-9-]+" 
               placeholder="my-app"
               style="border-radius: var(--radius) 0 0 var(--radius);">
        <span class="input-suffix">.onhyper.io</span>
      </div>
      <p class="form-hint">3-63 characters, lowercase letters, numbers, and hyphens only</p>
    </div>
    <button type="button" id="check-btn" onclick="checkAvailability(event)" class="btn-secondary" style="margin-top: 1.5rem;">
      Check Availability
    </button>
  </div>
  <div id="availability-result" class="availability-message"></div>
  <button type="submit" id="claim-btn" class="btn-primary" disabled style="margin-top: 1rem;">
    Claim Subdomain
  </button>
</form>

<!-- Release Confirmation Modal -->
<div id="release-modal" class="modal" style="display: none;">
  <div class="modal-overlay" onclick="closeModal()"></div>
  <div class="modal-content">
    <h3>Release Subdomain?</h3>
    <p>Are you sure you want to release <strong id="modal-subdomain"></strong>? This will make it available for others to claim.</p>
    <div class="modal-actions">
      <button onclick="closeModal()" class="btn-secondary">Cancel</button>
      <button onclick="confirmRelease()" class="btn-danger">Release</button>
    </div>
  </div>
</div>

<style>
.claim-form-row {
  display: flex;
  gap: 1rem;
  align-items: flex-end;
}

.input-with-suffix {
  display: flex;
  align-items: stretch;
}

.input-with-suffix input {
  border-radius: var(--radius) 0 0 var(--radius);
}

.input-suffix {
  display: flex;
  align-items: center;
  padding: 0 1rem;
  background: var(--bg-alt);
  border: 1px solid var(--border);
  border-left: none;
  border-radius: 0 var(--radius) var(--radius) 0;
  color: var(--text-muted);
  font-size: 0.95rem;
  white-space: nowrap;
}

.form-hint {
  font-size: 0.85rem;
  color: var(--text-muted);
  margin-top: 0.5rem;
}

.availability-message {
  margin-top: 1rem;
  padding: 0.75rem 1rem;
  border-radius: var(--radius);
  font-size: 0.9rem;
}

.availability-message.available {
  background: #ecfdf5;
  border: 1px solid #a7f3d0;
  color: var(--success);
}

.availability-message.unavailable {
  background: #fef2f2;
  border: 1px solid #fecaca;
  color: var(--error);
}

.availability-message.checking {
  background: var(--bg-alt);
  border: 1px solid var(--border);
  color: var(--text-muted);
}

/* Domain Card */
.domain-card {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 1.25rem;
  margin-bottom: 1rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 1rem;
}

.domain-info h3 {
  font-size: 1.1rem;
  margin-bottom: 0.25rem;
}

.domain-url {
  color: var(--primary);
  text-decoration: none;
  font-family: 'SF Mono', Monaco, monospace;
  font-size: 0.9rem;
}

.domain-url:hover {
  text-decoration: underline;
}

.domain-meta {
  display: flex;
  gap: 1rem;
  color: var(--text-muted);
  font-size: 0.85rem;
  margin-top: 0.5rem;
}

.domain-meta span {
  display: flex;
  align-items: center;
  gap: 0.25rem;
}

.domain-actions {
  display: flex;
  gap: 0.75rem;
}

/* Modal */
.modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 1000;
  display: flex;
  align-items: center;
  justify-content: center;
}

.modal-overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
}

.modal-content {
  position: relative;
  background: var(--bg);
  border-radius: var(--radius);
  padding: 2rem;
  max-width: 400px;
  width: 90%;
  box-shadow: 0 4px 24px rgba(0, 0, 0, 0.15);
}

.modal-content h3 {
  margin-bottom: 1rem;
}

.modal-content p {
  color: var(--text-muted);
  margin-bottom: 1.5rem;
}

.modal-actions {
  display: flex;
  justify-content: flex-end;
  gap: 0.75rem;
}

/* Empty state */
.empty-state {
  text-align: center;
  padding: 3rem 1rem;
  color: var(--text-muted);
}

.empty-state p {
  margin-bottom: 1rem;
}

/* Responsive */
@media (max-width: 768px) {
  .claim-form-row {
    flex-direction: column;
    align-items: stretch;
  }
  
  .claim-form-row button {
    margin-top: 0;
    width: 100%;
  }
  
  .domain-card {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .domain-actions {
    width: 100%;
    justify-content: flex-end;
    margin-top: 0.5rem;
  }
  
  .input-suffix {
    font-size: 0.85rem;
    padding: 0 0.75rem;
  }
}
</style>

<script>
let pendingReleaseSubdomain = null;
let subdomainData = [];

// Load domains on page init
loadDomains();

async function loadDomains() {
  if (!currentUser) {
    navigate('/login');
    return;
  }
  
  const list = document.getElementById('domains-list');
  
  try {
    const response = await api('/subdomains/mine');
    subdomainData = response.subdomains || [];
    
    if (subdomainData.length === 0) {
      list.innerHTML = `
        <div class="empty-state">
          <p>You haven't claimed any subdomains yet.</p>
          <p class="form-hint">Claim your first subdomain below to get a custom URL for your app!</p>
        </div>
      `;
      return;
    }
    
    list.innerHTML = subdomainData.map(domain => `
      <div class="domain-card">
        <div class="domain-info">
          <h3>${escapeHtml(domain.subdomain)}</h3>
          <a href="https://${domain.subdomain}.onhyper.io" target="_blank" class="domain-url">
            ${domain.subdomain}.onhyper.io
          </a>
          <div class="domain-meta">
            <span>
              ${domain.app_name ? `Linked to: <strong>${escapeHtml(domain.app_name)}</strong>` : '<em>Not linked to an app</em>'}
            </span>
            <span>·</span>
            <span>Claimed ${formatDate(domain.claimed_at)}</span>
          </div>
        </div>
        <div class="domain-actions">
          ${domain.app_name ? `
            <a href="https://${domain.subdomain}.onhyper.io" target="_blank" class="btn btn-secondary">Visit</a>
          ` : ''}
          <button onclick="showReleaseModal('${escapeHtml(domain.subdomain)}')" class="btn-danger">Release</button>
        </div>
      </div>
    `).join('');
  } catch (err) {
    list.innerHTML = `<p class="error">Failed to load domains: ${escapeHtml(err.message)}</p>`;
  }
}

async function checkAvailability(e) {
  e.preventDefault();
  
  const input = document.getElementById('subdomain-input');
  const result = document.getElementById('availability-result');
  const claimBtn = document.getElementById('claim-btn');
  const subdomain = input.value.trim().toLowerCase();
  
  if (!subdomain) {
    result.className = 'availability-message unavailable';
    result.textContent = 'Please enter a subdomain name';
    claimBtn.disabled = true;
    return;
  }
  
  if (subdomain.length < 3) {
    result.className = 'availability-message unavailable';
    result.textContent = 'Subdomain must be at least 3 characters';
    claimBtn.disabled = true;
    return;
  }
  
  result.className = 'availability-message checking';
  result.textContent = 'Checking availability...';
  
  try {
    const response = await api(`/subdomains/check?name=${encodeURIComponent(subdomain)}`);
    
    if (response.available) {
      result.className = 'availability-message available';
      result.textContent = `✓ ${subdomain}.onhyper.io is available!`;
      claimBtn.disabled = false;
    } else {
      result.className = 'availability-message unavailable';
      result.textContent = `✗ ${response.message}`;
      claimBtn.disabled = true;
    }
  } catch (err) {
    result.className = 'availability-message unavailable';
    result.textContent = `Error: ${err.message}`;
    claimBtn.disabled = true;
  }
}

async function claimSubdomain(e) {
  e.preventDefault();
  
  const input = document.getElementById('subdomain-input');
  const subdomain = input.value.trim().toLowerCase();
  
  if (!subdomain) return;
  
  try {
    await api('/subdomains/claim', {
      method: 'POST',
      body: JSON.stringify({ subdomain })
    });
    
    // Reset form
    input.value = '';
    document.getElementById('availability-result').textContent = '';
    document.getElementById('claim-btn').disabled = true;
    
    // Reload list
    loadDomains();
    
    // Show success briefly
    const result = document.getElementById('availability-result');
    result.className = 'availability-message available';
    result.textContent = `✓ Successfully claimed ${subdomain}.onhyper.io!`;
    
  } catch (err) {
    const result = document.getElementById('availability-result');
    result.className = 'availability-message unavailable';
    result.textContent = `Error: ${err.message}`;
  }
}

function showReleaseModal(subdomain) {
  pendingReleaseSubdomain = subdomain;
  document.getElementById('modal-subdomain').textContent = subdomain + '.onhyper.io';
  document.getElementById('release-modal').style.display = 'flex';
}

function closeModal() {
  pendingReleaseSubdomain = null;
  document.getElementById('release-modal').style.display = 'none';
}

async function confirmRelease() {
  if (!pendingReleaseSubdomain) return;
  
  const subdomain = pendingReleaseSubdomain;
  closeModal();
  
  try {
    await api(`/subdomains/${encodeURIComponent(subdomain)}`, {
      method: 'DELETE'
    });
    
    loadDomains();
  } catch (err) {
    showError(`Failed to release subdomain: ${err.message}`);
  }
}

function formatDate(dateString) {
  const date = new Date(dateString);
  const now = new Date();
  const diffMs = now - date;
  const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
  
  if (diffDays === 0) {
    return 'today';
  } else if (diffDays === 1) {
    return 'yesterday';
  } else if (diffDays < 7) {
    return `${diffDays} days ago`;
  } else {
    return date.toLocaleDateString('en-US', {
      month: 'short',
      day: 'numeric',
      year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined
    });
  }
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}
</script>