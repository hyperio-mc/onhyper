# OnHyper Memory - 2026-02-21

## ZIP Upload Path Transformation Fix

### Issue
When Next.js apps were deployed via ZIP upload, the HTML still had absolute paths like `href="/_next/..."` instead of relative `./_next/...`. The transformation code existed in render.ts but wasn't being applied correctly.

### Root Causes Found

1. **Missing return statement** - After the ZIP HTML transformation block, there was no `return c.html(modifiedHtml)`. The code fell through to the next block which got content from `AppContentStore` instead.

2. **Buggy regex** - The regex for `_vercel` paths was using `\"` instead of `\/`:
   ```javascript
   .replace(/href="\/_vercel\"/g, 'href="./_vercel/')  // WRONG - escaped quote
   .replace(/href="\/_vercel\//g, 'href="./_vercel/')  // CORRECT - forward slash
   ```

3. **Double-transformation risk** - The regex for converting `/something` to `./something` didn't exclude `_next/` and `_vercel/` paths that were already handled:
   ```javascript
   // OLD: Could convert /_next/... to ./_next/... then ././_next/...
   .replace(/href="\/(?!a\/|api\/|proxy\/)/g, 'href="./')
   
   // NEW: Excludes _next and _vercel from the catch-all
   .replace(/href="\/(?!a\/|api\/|proxy\/|_next\/|_vercel\/)/g, 'href="./')
   ```

4. **Duplicate route handlers** - There were two identical handlers for `/:slug/_next/:path*`.

5. **Unused code** - Empty if blocks, unused variables (`htmlWithMarker`), and useless string operations (`modifiedHtml = '' + modifiedHtml`).

### Fix Applied

Commit: `13a2b33` - "fix: ZIP upload path transformation for Next.js apps"

Key changes in `src/routes/render.ts`:
- Added `return c.html(modifiedHtml, 200);` after ZIP transformation
- Fixed `_vercel` regex from `\"` to `\/`
- Added `_next/` and `_vercel/` to the negative lookahead in the catch-all regex
- Removed duplicate route handler
- Cleaned up unused code

### Testing

Transformation function tested locally with all pass:
- Next.js `_next` paths: ✅
- Vercel `_vercel` paths: ✅
- Vite assets: ✅
- Preserve `/a/`, `/api/`, `/proxy/` paths: ✅

### Note on Test Apps

The Railway database is empty (separate volume from local). The `next-fresh` and `counter-app` apps mentioned in the original issue don't exist on Railway. To fully test:
1. Create an app via API
2. Upload a Next.js ZIP build
3. Verify paths are transformed correctly

### Files Changed
- `src/routes/render.ts` - Fixed transformation logic and cleaned up code